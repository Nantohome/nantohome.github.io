{"version":3,"file":"js/map.c1bcaab7.js","mappings":"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","sources":["webpack://lac/./src/views/pages/Lk/MapPage.vue?d1f2","webpack://lac/./src/views/pages/Lk/MapPage.vue"],"sourcesContent":["import { defineComponent as _defineComponent } from 'vue'\nimport { createVNode as _createVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\"\n\nconst _hoisted_1 = { class: \"lac-map\" }\n\nimport LacMap from \"@/views/components/LacMap/LacMap.vue\";\r\nimport { useStorePartner } from \"@/store/partner\";\r\nimport { storeToRefs } from \"pinia\";\r\nimport {\r\n  computed,\r\n  ComputedRef,\r\n  nextTick,\r\n  Ref,\r\n  ref,\r\n  watch,\r\n  watchEffect,\r\n  onMounted,\r\n} from \"vue\";\r\nimport { useStoreModal } from \"@/store/modal\";\r\nimport { AvailableModalsEnum } from \"@/store/modal/types\";\r\nimport {\r\n  LacMapComponentInterface,\r\n  Marker,\r\n} from \"@/views/components/LacMap/types\";\r\nimport { useStore } from \"@/store\";\r\nimport { useStoreUser } from \"@/store/user\";\r\nimport { useStorePoint } from \"@/store/point\";\r\nimport { PointEntity } from \"@/kernel/entities/Point\";\r\n\r\n\nexport default /*#__PURE__*/_defineComponent({\n  __name: 'MapPage',\n  setup(__props) {\n\r\nconst storePoint = useStorePoint();\r\nconst storePartner = useStorePartner();\r\nconst storeUser = useStoreUser();\r\nconst { dictionary } = storeToRefs(useStore());\r\nconst { selectUserId } = storeToRefs(storeUser);\r\nconst { points, isStoreChanged } = storeToRefs(storePoint);\r\nconst { selectPartnerId, partnerTableOpt } = storeToRefs(storePartner);\r\nconst modals = useStoreModal();\r\n\r\nconst mapRef: Ref<LacMapComponentInterface | null> = ref(null);\r\nconst markers: Ref<Marker[]> = ref([]);\r\n\r\nfunction showPoints() {\r\n  const searchParam: {\r\n    user_id?: number;\r\n    partner_id?: number;\r\n    partner_name?: string;\r\n  } = {\r\n    user_id: undefined,\r\n    partner_id: undefined,\r\n    partner_name: undefined,\r\n  };\r\n\r\n  selectUserId.value && (searchParam.user_id = selectUserId.value);\r\n  partnerTableOpt.value.search &&\r\n    (searchParam.partner_name = partnerTableOpt.value.search);\r\n  selectPartnerId.value && (searchParam.partner_id = selectPartnerId.value);\r\n\r\n  console.log(`POINT SEARCH`, searchParam);\r\n  // сложит поинты в стор points\r\n  storePoint.getPoints(searchParam);\r\n\r\n  viewOnMap();\r\n}\r\n\r\nfunction genMarker(points: PointEntity[]) {\r\n  const markers: Marker[] = [];\r\n  for (let i in points) {\r\n    const point = points[i];\r\n    const latLng = point.location.split(\", \");\r\n    if (latLng.length !== 2) continue;\r\n    const subjects = dictionary.value.point.subject;\r\n    const sell = point.subject_to_sell.map(\r\n      (key): string => subjects[key]?.desc\r\n    );\r\n    const buy = point.subject_to_buy.map((key): string => subjects[key]?.desc);\r\n\r\n    const info: { label: string; text: string; link?: number }[] = [\r\n      {\r\n        label: \"Контрагент\",\r\n        text: point.partner_fullname || \"\",\r\n        link: point.partner_id,\r\n      },\r\n    ];\r\n\r\n    info.push({\r\n      label: \"Адрес\",\r\n      text: [point.region, point.district, point.locality].join(\", \"),\r\n    });\r\n\r\n    sell.length && info.push({ label: \"Продает\", text: sell.join(\", \") });\r\n    buy.length && info.push({ label: \"Закупает\", text: buy.join(\", \") });\r\n\r\n    markers.push({\r\n      position: {\r\n        lat: Number(latLng[0]),\r\n        lng: Number(latLng[1]),\r\n      },\r\n      title: point.name,\r\n      type: point.partner_type,\r\n      info,\r\n    });\r\n  }\r\n  return markers;\r\n}\r\n\r\n// перегенер гугл карты.\r\nfunction viewOnMap() {\r\n  markers.value = genMarker(points.value);\r\n\r\n  if (!markers.value.length) {\r\n    mapRef.value?.panTo({ lat: 55.796127, lng: 49.106414 });\r\n    return mapRef.value?.setZoom(6);\r\n  }\r\n  if (markers.value.length === 1) {\r\n    const [marker] = markers.value;\r\n    mapRef.value?.panTo(marker.position);\r\n    mapRef.value?.setZoom(6);\r\n    return;\r\n  }\r\n  const positions = markers.value.map((m) => m.position);\r\n  mapRef.value?.panToMultiple(positions);\r\n\r\n  // сбросить флаг необновленного показа пунктов.\r\n  storePoint.storeNotChanged();\r\n}\r\n\r\nasync function init() {\r\n  // показ только нужных поинтов.\r\n  showPoints();\r\n  console.log(\"Init at MapPage\");\r\n}\r\n\r\nwatch(\r\n  () => [\r\n    selectPartnerId.value,\r\n    selectUserId.value,\r\n    partnerTableOpt.value.search,\r\n  ],\r\n  () => {\r\n    showPoints();\r\n  }\r\n);\r\n\r\nwatch(\r\n  () => isStoreChanged.value,\r\n  () => {\r\n    console.log(\"global point store changed!\");\r\n    viewOnMap();\r\n  }\r\n);\r\n\r\nonMounted(async () => {\r\n  init();\r\n});\r\n\nreturn (_ctx: any,_cache: any) => {\n  return (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [\n    _createVNode(LacMap, {\n      markers: markers.value,\n      ref_key: \"mapRef\",\n      ref: mapRef\n    }, null, 8, [\"markers\"])\n  ]))\n}\n}\n\n})","import script from \"./MapPage.vue?vue&type=script&lang=ts&setup=true\"\nexport * from \"./MapPage.vue?vue&type=script&lang=ts&setup=true\"\n\nimport \"./MapPage.vue?vue&type=style&index=0&id=257057c4&lang=scss\"\n\nconst __exports__ = script;\n\nexport default __exports__"],"names":["_hoisted_1","class","_defineComponent","__name","setup","__props","storePoint","useStorePoint","storePartner","useStorePartner","storeUser","useStoreUser","dictionary","storeToRefs","useStore","selectUserId","points","isStoreChanged","selectPartnerId","partnerTableOpt","mapRef","useStoreModal","ref","markers","showPoints","searchParam","user_id","undefined","partner_id","partner_name","value","search","console","log","getPoints","viewOnMap","genMarker","i","point","latLng","location","split","length","subjects","subject","sell","subject_to_sell","map","key","desc","buy","subject_to_buy","info","label","text","partner_fullname","link","push","region","district","locality","join","position","lat","Number","lng","title","name","type","partner_type","panTo","setZoom","marker","positions","m","panToMultiple","storeNotChanged","async","init","watch","onMounted","_ctx","_cache","_openBlock","_createElementBlock","_createVNode","LacMap","ref_key","__exports__"],"sourceRoot":""}
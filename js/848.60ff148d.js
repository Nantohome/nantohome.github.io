"use strict";(self["webpackChunklac"]=self["webpackChunklac"]||[]).push([[848],{1482:function(a,e,t){t.d(e,{C9:function(){return o},Vv:function(){return c},g5:function(){return s},sh:function(){return i},wu:function(){return u},yw:function(){return n}});var r=t(7542),l=t(8020);const u=async a=>{const e=await(0,r.I)().get("/offer/calc",{searchParams:a});if(!e)throw new l.u(u.name);return e},s=async a=>{const e=await(0,r.I)().get("/offer/delete",{searchParams:{offer_id:a}});if(!e)throw new l.u(s.name);return e},i=async a=>{const e=await(0,r.I)().get("/offer/get",{searchParams:{offer_id:a}});if(!e)throw new l.u(i.name);return e},n=async a=>{const e=await(0,r.I)().get("/offer/list",{searchParams:{...a}});if(!e)throw new l.u(n.name);return e},o=async a=>{const e=await(0,r.I)().post("/offer/add",{...a,param:JSON.stringify(a.param)});if(!e)throw new l.u(o.name);return e},c=async a=>{const e=await(0,r.I)().post("/offer/edit",{...a,param:JSON.stringify(a.param)});if(!e)throw new l.u(c.name);return e}},2192:function(a,e,t){t.d(e,{p:function(){return r}});const r=10},76:function(a,e,t){t.d(e,{k:function(){return r}});const r=(a,e=0)=>new Intl.NumberFormat("ru-RU",{minimumFractionDigits:e,maximumFractionDigits:e}).format("string"===typeof a?+a.replaceAll(/\s/g,"").replace(",","."):a).replace(",",".")},8225:function(a,e,t){t.d(e,{x:function(){return l}});var r=t(5420);const l=a=>({min:r.BM.withMessage(`Минимальное значение ${a||0}`,(e=>Number(e.replace(/\s/g,""))>=(a||0)))})},2057:function(a,e,t){t.d(e,{a:function(){return k}});var r=t(1735),l=t(4870),u=t(6945),s=t(8225),i=t(4008);const n=()=>{const a={partner:{value:null,id:"partner_id",label:"Поставщик",items:[],rules:(0,u.v)(),placeholder:"",available:!0},point:{value:null,id:"point_id",label:"Пункт",items:[],rules:(0,u.v)(),placeholder:"",available:!0},subject:{value:null,id:"subject",label:"Предмет",items:[],rules:(0,u.v)(),placeholder:"",available:!0},statusSelect:{value:null,id:"status",label:"Статус",items:[],rules:(0,u.v)(),placeholder:"Выберите статус",available:!0},weight:{id:"weight",label:"Вес",value:"",unit:"кг",step:1e3,min:0,max:1e5,afterDot:0,rules:{...(0,u.v)(),...(0,s.x)(1)},available:!0},carCount:{id:"carCount",label:"Количество машин",value:"",unit:"шт",step:.01,min:0,afterDot:2,rules:{},available:!0}},e=(0,l.qj)({base_price:{id:"base_price",label:"Базовая цена (без НДС)",unit:"₽/кг",value:"",hidden:"",afterDot:2,step:.5,min:0,max:50,rules:(0,u.v)(),available:!0},base_dry_matter:{id:"base_dry_matter",label:"Базовые сухие вещества",unit:"%",value:"",available:!0},base_price_with_tax:{id:"base_price_with_tax",label:"Базовая цена (с НДС)",unit:"₽/кг",value:"",afterDot:2,step:.5,min:0,max:55,available:!0},protein_rate:{id:"protein_rate",label:"Доля показателя белка",unit:"%",value:"",available:!0},formula:{value:null,id:"formula",label:"Тип формулы рассчета",items:[],rules:(0,u.v)(),placeholder:"",available:!0},fat_rate:{id:"fat_rate",label:"Доля показателя жира",unit:"%",value:"",available:!0},base_protein:{id:"base_protein",label:"Базовый белок",unit:"%",value:"",available:!0},protein_correction:{id:"protein_correction",label:"Поправка на белок",unit:"коп",value:"",available:!0},base_fat:{id:"base_fat",label:"Базовый жир",unit:"%",value:"",available:!0},fat_correction:{id:"fat_correction",label:"Поправки на жир",unit:"коп",value:"",available:!0},max_fat:{id:"max_fat",label:"Потолок жира",unit:"%",value:"",available:!0}}),t=(0,l.qj)({actual_protein:{id:"actual_protein",label:"Фактический белок",unit:"%",value:"",available:!0},sort:{value:null,id:"sort",label:"Сорт",items:[],rules:(0,u.v)(),placeholder:"Выберите сорт",available:!0},actual_fat:{id:"actual_fat",label:"Фактический жир",unit:"%",value:"",available:!0},class_rate:{id:"class_rate",label:"Коэффициент сортности",value:"1.000",afterDot:3,step:.1,available:!0},actual_dry_matter:{id:"actual_dry_matter",label:"Фактические сухие вещества",unit:"%",value:"",available:!0}}),r=(0,l.qj)({final_price:{id:"final_price",label:"Конечная цена (без НДС)",unit:"₽/кг",value:"",min:0,step:.01,afterDot:2,available:!0},cost:{id:"cost",label:"Сумма (без НДС)",unit:"₽",value:"",min:0,afterDot:0,available:!0},final_price_with_vat:{id:"final_price_with_vat",label:"Конечная цена (с НДС)",unit:"₽/кг",value:"",min:0,step:.01,afterDot:2,available:!0},cost_with_vat:{id:"cost_with_vat",label:"Сумма (с НДС)",unit:"₽",value:"",min:0,afterDot:0,available:!0}}),n=(0,l.qj)({other_price:{id:"other_price",label:"Прочие расходы",unit:"₽/кг",value:"",afterDot:2,step:.1,min:0,max:10,available:!0},comment:{id:"comment",label:"Комментарий",value:"",rules:(0,i.F)()}}),o=(0,l.qj)({commonParams:a,baseParams:e,factParams:t,calculateParams:r,other:n});return{fields:o}};t(7658);var o=t(3396);const c=(a,e)=>{const{updateSubject:t,updatePoint:r,updateFormula:u,initialParams:s,recalculateFatRate:i,recalculateBasePrice:n,recalculateBasePriceWithVat:c,recalculateCarCount:m,recalculateWeight:v,fetchCalculate:f}=e,b=(0,l.iH)(!1),p=(0,l.iH)([]);function d(){p.value.push((0,o.YP)((()=>a.commonParams.partner.value?.value),(async e=>{if(b.value)return;const t=e?parseInt(e):void 0;await r(a.commonParams.point,"offer",t)}))),p.value.push((0,o.YP)((()=>a.commonParams.point.value?.value),(async e=>{if(b.value)return;const r=e?parseInt(e):void 0;await t(a.commonParams.subject,"offer",r)}))),p.value.push((0,o.YP)((()=>a.commonParams.subject.value?.value),(async()=>{if(b.value)return;const e=a.commonParams.subject.value?a.commonParams.subject.value.value:void 0;await u(a.baseParams.formula,e),s()}))),p.value.push((0,o.YP)((()=>a.baseParams.formula.value),(()=>{b.value||s()}))),p.value.push((0,o.YP)((()=>a.baseParams.protein_rate.value),(()=>{b.value||i()}))),p.value.push((0,o.YP)((()=>[a.baseParams.base_price.value,a.baseParams.base_price.hidden]),(([,a],[,e])=>{b.value||a!==e&&c()}))),p.value.push((0,o.YP)((()=>a.baseParams.base_price_with_tax.value),(()=>{b.value||n()}))),p.value.push((0,o.YP)((()=>({subject:a.commonParams.subject.value,status:a.commonParams.statusSelect.value,weight:a.commonParams.weight.value,baseParams:a.baseParams,factParams:a.factParams,otherPrice:a.other.other_price})),(()=>{b.value||f()}),{deep:!0})),p.value.push((0,o.YP)((()=>a.commonParams.weight.value),(()=>{b.value||m()}))),p.value.push((0,o.YP)((()=>a.commonParams.carCount.value),(()=>{b.value||v()})))}return{setWatchers:d,lockWatchers:()=>b.value=!0,unlockWatchers:()=>b.value=!1}};var m=t(1020),v=t(5845);const f=a=>{const{dictionary:e}=(0,m.Jk)((0,v.o)());function t(){const t=e.value.offer.formula,r=e.value.offer.available_formula_by_subject;if(a.baseParams.formula.items=Object.entries(t).filter((([e,t])=>!!a.commonParams.subject.value?.value&&r[a.commonParams.subject.value.value].some((a=>a===e)))).map((([a,e])=>({value:a,text:e}))),"milk"===a.commonParams.subject.value?.value){const t=a.baseParams.formula.items.find((a=>"standart"===a.value));if(t)a.baseParams.formula.value=t;else{const t=a.baseParams.formula.items.find((a=>"physical_weight"===a.value));t&&(a.baseParams.formula.value=t),e.value.offer.status.ready_to_sell&&(a.commonParams.statusSelect.value=a.commonParams.statusSelect.items.find((a=>"ready_to_sell"===a.value))||null)}}else{const t=a.baseParams.formula.items.find((a=>"physical_weight"===a.value));t&&(a.baseParams.formula.value=t),e.value.offer.status.ready_to_sell&&(a.commonParams.statusSelect.value=a.commonParams.statusSelect.items.find((a=>"ready_to_sell"===a.value))||null)}}return{setFormula:t}},b=a=>{const{dictionary:e}=(0,m.Jk)((0,v.o)());function t(){const t=e.value.offer.property,r=["protein_rate","actual_dry_matter","actual_fat","actual_protein","base_dry_matter","base_fat","base_protein","fat_correction","fat_rate","max_fat","protein_correction","protein_rate"];r.forEach((e=>{a.baseParams[e]&&(a.baseParams[e].available=!1),a.factParams[e]&&(a.factParams[e].available=!1)}));const l=e=>{const r=a.baseParams.formula.value?.value||"",l=a.commonParams.subject.value?.value||"",u=a[e],s=Object.entries(t);if(u){const a=Object.entries(u).filter((([a,e])=>s.some((([e,t])=>e===a))));a.forEach((([a,e])=>{e.value=""}))}s.forEach((([t,u])=>{const s=a[e][t],i=u.cond[r]?.[l];s&&i&&("number"===typeof i.max?s.max=i.max:delete s.max,"number"===typeof i.min?s.min=i.min:delete s.min,"number"===typeof i.fix?(s.min=i.fix,s.max=i.fix,s.fix=i.fix):delete s.fix,"number"===typeof i.after_dot?s.afterDot=i.after_dot:delete s.afterDot,"number"===typeof i.step?s.step=i.step:delete s.step,s.available=!0,void 0!==i.def?s.value="number"===typeof s.afterDot?i.def.toFixed(s.afterDot):String(i.def):s.value="number"===typeof i.fix?"number"===typeof s.afterDot?i.fix.toFixed(s.afterDot):String(i.fix):"",a[e][t]=s)}))};l("factParams"),l("baseParams"),Number(a.baseParams.protein_rate.value)+Number(a.baseParams.fat_rate.value)>100&&(a.baseParams.fat_rate.value=String(100-Number(a.baseParams.protein_rate.value)))}return{initialParams:t}};var p=t(774),d=t(2192),P=t(1482);const _=a=>{function e(){if(!a.commonParams.partner.value||!a.commonParams.subject.value||!a.baseParams.formula.value||!a.baseParams.base_price.hidden||!a.factParams.sort.value)return null;const e={partner_id:String(a.commonParams.partner.value?.value),weight:a.commonParams.weight.value.replace(/\s/g,""),car_count:a.commonParams.carCount.value,class:a.factParams.sort.value?.value,class_rate:a.factParams.class_rate.value,base_price:a.baseParams.base_price.hidden,other_price:a.other.other_price.value,formula_type:a.baseParams.formula.value?.value,param:{subject:a.commonParams.subject.value.value,formula:a.baseParams.formula.value?.value}};return a.other.comment.value&&(e.comment=a.other.comment.value),a.commonParams.point.value&&(e.point_id=a.commonParams.point.value.value),Object.entries(a.baseParams).filter((([a,e])=>e.available&&"formula"!==a&&"base_price"!==a&&"base_price_with_tax"!==a)).forEach((([a,t])=>{e.param[a]=t.value})),Object.entries(a.factParams).filter((([a,e])=>e.available&&"sort"!==a&&"class_rate"!==a)).forEach((([a,t])=>{e.param[a]=t.value})),a.commonParams.statusSelect.value&&(e.status=a.commonParams.statusSelect.value.value),e}return{prepareData:e}};var h=t(76);const w=(a,e)=>{const{dictionary:t}=(0,m.Jk)((0,v.o)()),r=(0,l.iH)(!1),u=(0,l.iH)(!1),{prepareData:s}=_(a);function i(){a.commonParams.subject.value&&"milk"===a.commonParams.subject.value.value&&a.baseParams.formula.value&&"standart"==a.baseParams.formula.value.value&&(a.baseParams.fat_rate.value=String(100-Number(a.baseParams.protein_rate.value)))}function n(e){if(!r.value){r.value=!0;const l=Number(a.baseParams.base_price.value),u=Number(a.baseParams.base_price.hidden);e?(a.baseParams.base_price.hidden=l.toFixed(4),a.baseParams.base_price.value=l.toFixed(2)):(u>(a.baseParams.base_price.max||0)||u<(a.baseParams.base_price.min||0))&&(a.baseParams.base_price.hidden=l.toFixed(4)),a.baseParams.base_price_with_tax.value=(l*((t.value.offer.vat_rate||d.p)/100)+l).toFixed(2),(0,o.Y3)().then((()=>{r.value=!1}))}}function c(){if(!r.value){r.value=!0;const e=Number(a.baseParams.base_price_with_tax.value),l=e/(1+(t.value.offer.vat_rate||d.p)/100);a.baseParams.base_price.hidden=l.toFixed(4),a.baseParams.base_price.value=l.toFixed(2),(0,o.Y3)().then((()=>{r.value=!1}))}}function f(){if(!r.value){r.value=!0;const e=Number(a.commonParams.weight.value.replace(/\s/g,""));a.commonParams.carCount.value=(e/27800).toFixed(2),(0,o.Y3)().then((()=>{r.value=!1}))}}async function b(){if(!r.value){r.value=!0;const e=a.commonParams.weight.max||0,t=a.commonParams.carCount.value?parseFloat(a.commonParams.carCount.value):0;a.commonParams.weight.value=(0,h.k)(Math.min(e,27800*t)),(0,o.Y3)().then((()=>{r.value=!1}))}}const w=(0,p.D)((async()=>{if(await(0,o.Y3)(),e.value&&!u.value){u.value=!0,a.calculateParams.cost.value="",a.calculateParams.cost_with_vat.value="",a.calculateParams.final_price.value="",a.calculateParams.final_price_with_vat.value="";const e=s();if(e){const t=await(0,P.wu)({...e,param:JSON.stringify(e.param)});if(!t.error&&t.data.info){const e=t.data.info;a.calculateParams.cost.value=(0,h.k)(e.cost),a.calculateParams.cost_with_vat.value=(0,h.k)(e.cost_with_vat),a.calculateParams.final_price.value=(0,h.k)(e.final_price,2),a.calculateParams.final_price_with_vat.value=(0,h.k)(e.final_price_with_vat,2)}}u.value=!1}}),1500);return{recalculateFatRate:i,recalculateBasePrice:c,recalculateBasePriceWithVat:n,recalculateCarCount:f,recalculateWeight:b,fetchCalculate:w,calculateLock:u,lockCalculate:()=>u.value=!0,unlockCalculate:()=>u.value=!1}},y=(a,e,t,r,l)=>{const{setFormula:u}=f(a),{initialParams:s}=b(a),{recalculateBasePriceWithVat:i,fetchCalculate:n}=w(a,t);async function c(){if(!e.value)return;t.value=!1,r(),a.commonParams.weight.value=(0,h.k)(e.value.weight),a.commonParams.carCount.value=String(e.value.car_count),a.baseParams.base_price.value=String(e.value.base_price),i(!0);const u=a.factParams.sort.items.find((a=>a.value===e.value.class));u&&(a.factParams.sort.value=u),e.value?.class_rate&&(a.factParams.class_rate.value=String(e.value.class_rate)),e.value?.other_price&&(a.other.other_price.value=String(e.value.other_price)),e.value?.comment&&(a.other.comment.value=String(e.value.comment));const s=e.value?.param;s&&Object.entries(s).forEach((([e,t])=>{a.baseParams[e]?a.baseParams[e].value=String(t):a.factParams[e]&&(a.factParams[e].value=String(t))})),await(0,o.Y3)(),t.value=!0,await n(),l()}return{fillForm:c}};var x=t(3856),g=t(9286),j=t(9358);const D=(a,e,t,r)=>{const u=(0,g.N)(),{dictionary:s}=(0,m.Jk)((0,v.o)()),{initialParams:i}=b(a),{updatePartner:n,updatePoint:c,updateSubject:f,updateFormula:p,updateStatus:d}=(0,j.P)(e),P=(0,l.qj)({extra:2,first:3,not_sorted:5,second:4,ultra:1}),_=(0,o.Fl)((()=>{const a={},e=s.value?.point.class||{};return Object.entries(e).forEach((([e,t])=>{a[e]={text:t,val:P[e]||0}})),Object.entries(a).map((([a,e])=>({value:a,text:e.text,val:e.val}))).sort(((a,e)=>a.val-e.val))}));async function h(){let e,r,l,u,s,o;t.value&&(e=!0,r=t.value.partner.partner_id,l=t.value.point.point_id,u=t.value.subject,s=t.value.formula,o=t.value.status),await n(a.commonParams.partner,r),!e&&a.commonParams.partner.value&&(r=parseInt(a.commonParams.partner.value.value)),await c(a.commonParams.point,"offer",r,l),!e&&a.commonParams.point.value&&(l=parseInt(a.commonParams.point.value.value)),await f(a.commonParams.subject,"offer",l,u);const m=a.commonParams.subject.value?a.commonParams.subject.value.value:void 0;await p(a.baseParams.formula,m,s),await d(a.commonParams.statusSelect,"offer",o),a.factParams.sort.items.push(..._.value),a.factParams.sort.value=a.factParams.sort.items.find((a=>"first"===a.value))||null,a.commonParams.subject.value&&i(),a.commonParams.carCount.max=(a.commonParams.weight.max||0)/27800}async function w(){u.open(x.y.LOADER),await h(),e.value=!0,await(0,o.Y3)(),r(),u.close()}return{init:w}};var S=t(2483);const F=a=>{const e=(0,g.N)(),t=(0,S.tv)(),{prepareData:r}=_(a);async function l(){const a=r();if(a){e.open(x.y.LOADER);const r=await(0,P.C9)(a);r.error?e.open(x.y.ERROR,{text:r.data.info||"Ошибка создания предложения"}):e.open(x.y.SUCCESS,{callback:()=>t.back()})}}async function u(a){await(0,o.Y3)();const l=r();if(l){e.open(x.y.LOADER);const r=await(0,P.Vv)({...l,offer_id:a});r.error?e.open(x.y.ERROR,{text:r.data.info||"Ошибка редактирования предложения"}):e.open(x.y.SUCCESS,{callback:()=>t.back()})}}return{submit:l,submitEdit:u}},C=()=>{const a=(0,l.iH)(null);async function e(e){const t=await(0,P.sh)(e);!t.error&&t.data.info&&(a.value=t.data.info)}return{fetchData:e,offerData:a}},k=()=>{const{setFieldRef:a,validateForm:e,resetValidations:t}=(0,r.Z)(),u=(0,l.iH)(!1),s=(0,l.iH)(!0),{fields:i}=n(),{offerData:o,fetchData:m}=C(),{submit:v,submitEdit:p}=F(i),{recalculateFatRate:d,recalculateBasePrice:P,recalculateBasePriceWithVat:_,recalculateCarCount:h,recalculateWeight:x,fetchCalculate:g}=w(i,u),{updatePoint:S,updateSubject:k,updateFormula:N,updateStatus:E}=(0,j.P)(u),{setFormula:Y}=f(i),{initialParams:R}=b(i),{setWatchers:O,lockWatchers:W,unlockWatchers:I}=c(i,{updateSubject:k,updatePoint:S,updateFormula:N,initialParams:R,recalculateFatRate:d,recalculateBasePrice:P,recalculateBasePriceWithVat:_,recalculateCarCount:h,recalculateWeight:x,fetchCalculate:g}),{fillForm:B}=y(i,o,u,W,I),{init:V}=D(i,u,o,O);return{fields:i,setFieldRef:a,validateForm:e,resetValidations:t,init:V,fetchData:m,fillForm:B,isInit:u,submit:v,submitEdit:p,isChanged:s}}},3653:function(a,e,t){t.d(e,{Z:function(){return b}});var r=t(3396),l=t(7139),u=t(5838),s=t(4870),i=t(4219),n=t(76),o=t(3435);const c={class:"p-inputgroup flex-1"},m={class:"p-inputgroup-addon",style:{background:"#fafafa"}};var v=(0,r.aZ)({__name:"LacInputNumber",props:{label:{},placeholder:{},id:{},value:{},hidden:{},icon:{},rules:{},type:{},disabled:{type:Boolean},step:{default:1},min:{},max:{},afterDot:{},suffix:{},localePrettify:{type:Boolean}},emits:["update:value","focus","blur"],setup(a,{expose:e,emit:t}){const v=a,f=(0,o.p)(),b=((0,s.iH)(!1),(0,i.ZP)({props:{value:v.rules||{}}},{props:v})),p=(0,r.Fl)((()=>!!b.value.$errors.length)),d=(0,r.Fl)({get(){return v.value},set(a){t("update:value",a.replace(",","."))}});async function P(){const a=await b.value.$validate();return a||f.add({severity:"error",summary:v.label,detail:b.value.$errors[0].$message}),a}function _(){b.value.$reset()}async function h(a){await(0,r.Y3)(),window.removeEventListener("keyup",x),"base_price"===a&&t("blur",d.value),d.value=v.localePrettify?(0,n.k)(y(d.value),v.afterDot||0):y(d.value)}function w(a){"base_price"===a&&t("focus"),window.addEventListener("keyup",x)}function y(a){let e=Number(String(a).replace(/\s/g,"").replace(",","."));"number"===typeof v.max&&"number"===typeof v.min&&v.max===v.min?e=v.max:("number"===typeof v.max&&e>v.max&&(e=v.max),"number"===typeof v.min&&e<v.min&&(e=v.min));let t=Number.isNaN(e)?"0":"number"===typeof v.afterDot?e.toFixed(v.afterDot):String(e);return t}function x(a){38!==a.keyCode?40!==a.keyCode||D():j()}function g(a){return a.replace(",",".").split(".")}function j(){const a=y(d.value),e=g(a),t=v.afterDot||e[1]?e[1].length:0;let r="1";for(let s=0;s<t;s++)r+="0";const l=v.afterDot?Number(Number(a).toFixed(v.afterDot)):Number(a);let u=(l*Number(r)+v.step*Number(r))/Number(r);v.max&&u>v.max&&(u=v.max),d.value=y(String(u))}function D(){const a=y(d.value),e=g(a),t=v.afterDot||e[1]?e[1].length:0;let r="1";for(let s=0;s<t;s++)r+="0";const l=v.afterDot?Number(Number(a).toFixed(v.afterDot)):Number(a);let u=(l*Number(r)-v.step*Number(r))/Number(r);v.min&&u<v.min&&(u=v.min),d.value=y(String(u))}return e({validate:P,validationReset:_,id:v.id}),(a,e)=>{const t=(0,r.up)("InputText");return(0,r.wg)(),(0,r.j4)(u.Z,{id:v.id,label:v.label},{default:(0,r.w5)((()=>[(0,r._)("div",c,[(0,r.Wm)(t,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=a=>d.value=a),id:v.id,class:(0,l.C_)(["w-100",{"p-invalid":p.value}]),placeholder:v.placeholder,disabled:a.disabled,onFocus:e[1]||(e[1]=a=>w(v.id)),onBlur:e[2]||(e[2]=a=>h(v.id))},null,8,["modelValue","id","class","placeholder","disabled"]),(0,r._)("span",m,(0,l.zw)(v.suffix),1)])])),_:1},8,["id","label"])}}});const f=v;var b=f}}]);
//# sourceMappingURL=848.60ff148d.js.map